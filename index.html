<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TeamKick - Youth Soccer Coordination</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; }
    .app { max-width: 430px; margin: 0 auto; min-height: 100vh; background: white; position: relative; }
    .hidden { display: none !important; }

    /* Header */
    .header { padding: 16px 20px; background: white; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 50; }
    .header h1 { color: #16a34a; font-size: 24px; font-weight: 700; }
    .header-right { display: flex; align-items: center; gap: 10px; }
    .coach-badge { background: #fef3c7; color: #b45309; padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 600; }
    .avatar-btn { width: 36px; height: 36px; border-radius: 50%; background: #f0f0f0; border: none; cursor: pointer; font-size: 18px; }

    /* Content */
    .content { padding: 20px; padding-bottom: 100px; }

    /* Cards */
    .card { background: white; border-radius: 14px; padding: 16px; margin-bottom: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }

    /* Buttons */
    .btn { padding: 14px 20px; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; width: 100%; margin-bottom: 10px; }
    .btn-primary { background: #16a34a; color: white; }
    .btn-outline { background: white; color: #16a34a; border: 2px solid #16a34a; }
    .btn-small { padding: 8px 14px; font-size: 13px; width: auto; margin: 0; border-radius: 8px; }
    .btn-danger { background: #fef2f2; color: #dc2626; }

    /* Inputs */
    .input-group { margin-bottom: 16px; }
    .input-group label { display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px; }
    .input { width: 100%; padding: 12px 14px; border: 1px solid #d1d5db; border-radius: 10px; font-size: 16px; outline: none; }
    .input:focus { border-color: #16a34a; }

    /* Navigation */
    .nav { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 430px; background: white; border-top: 1px solid #eee; display: flex; justify-content: space-around; padding: 12px 0; z-index: 100; }
    .nav-item { background: none; border: none; display: flex; flex-direction: column; align-items: center; gap: 4px; cursor: pointer; color: #9ca3af; font-size: 11px; font-weight: 500; padding: 4px 12px; }
    .nav-item.active { color: #16a34a; }
    .nav-item span:first-child { font-size: 22px; }

    /* Hero */
    .hero { background: linear-gradient(135deg, #16a34a 0%, #15803d 100%); border-radius: 20px; padding: 24px; color: white; margin-bottom: 20px; }
    .hero.blue { background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%); }
    .hero-badge { background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; display: inline-block; margin-bottom: 8px; }
    .hero h2 { font-size: 24px; font-weight: 700; }
    .hero p { opacity: 0.8; margin-top: 4px; font-size: 14px; }
    .hero-stats { display: flex; gap: 12px; margin-top: 16px; }
    .hero-stat { background: rgba(255,255,255,0.2); border-radius: 12px; padding: 12px 20px; text-align: center; }
    .hero-stat-num { font-size: 24px; font-weight: 700; }
    .hero-stat-label { font-size: 11px; opacity: 0.8; }

    /* Section */
    .section-title { font-size: 18px; font-weight: 600; color: #1f2937; margin-bottom: 12px; margin-top: 8px; }

    /* Player Card */
    .player-card { display: flex; align-items: center; gap: 12px; }
    .player-avatar { width: 48px; height: 48px; background: #dcfce7; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px; }
    .player-info { flex: 1; }
    .player-name { font-weight: 600; }
    .player-detail { font-size: 13px; color: #6b7280; }
    .player-stats { display: flex; gap: 16px; }
    .player-stat { text-align: center; }
    .player-stat-num { font-size: 18px; font-weight: 700; color: #16a34a; }
    .player-stat-label { font-size: 10px; color: #9ca3af; }

    /* Event Card */
    .event-card { display: flex; align-items: center; gap: 12px; cursor: pointer; flex-wrap: wrap; }
    .event-icon { width: 56px; height: 56px; border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 26px; }
    .event-icon.game { background: #ffedd5; }
    .event-icon.practice { background: #dbeafe; }
    .event-info { flex: 1; min-width: 150px; }
    .event-title { font-weight: 600; font-size: 16px; }
    .event-time { font-size: 13px; color: #6b7280; margin-top: 2px; }
    .event-location { font-size: 12px; color: #9ca3af; margin-top: 4px; }
    .event-badge { font-size: 11px; font-weight: 600; padding: 4px 8px; border-radius: 6px; background: #f3f4f6; }
    .event-actions { width: 100%; display: flex; gap: 8px; margin-top: 12px; padding-top: 12px; border-top: 1px solid #f3f4f6; }
    .directions-btn-small { background: #4285f4; color: white; border: none; border-radius: 8px; padding: 8px 12px; font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px; flex: 1; justify-content: center; }
    .directions-btn-small:hover { background: #3367d6; }

    /* Quick Actions */
    .quick-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 24px; }
    .quick-btn { background: white; border: none; border-radius: 14px; padding: 16px 8px; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 8px; font-size: 11px; color: #374151; font-weight: 500; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
    .quick-btn span:first-child { font-size: 28px; }

    /* Schedule Card */
    .schedule-card { display: flex; gap: 16px; align-items: center; cursor: pointer; }
    .schedule-date { text-align: center; min-width: 50px; }
    .schedule-month { font-size: 11px; color: #6b7280; }
    .schedule-day { font-size: 28px; font-weight: 700; }
    .schedule-info { flex: 1; }
    .schedule-type { font-size: 9px; font-weight: 600; padding: 3px 8px; border-radius: 4px; text-transform: uppercase; display: inline-block; margin-bottom: 4px; }
    .schedule-type.game { background: #fed7aa; color: #c2410c; }
    .schedule-type.practice { background: #bfdbfe; color: #1d4ed8; }

    /* Chat List */
    .chat-item { display: flex; align-items: center; gap: 12px; padding: 16px; background: white; border-radius: 14px; margin-bottom: 8px; cursor: pointer; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
    .chat-icon { width: 52px; height: 52px; background: #f3f4f6; border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 24px; }
    .chat-info { flex: 1; }
    .chat-name { font-weight: 600; }
    .chat-preview { font-size: 13px; color: #6b7280; }

    /* Roster Card */
    .roster-card { display: flex; align-items: center; gap: 12px; }
    .jersey { width: 44px; height: 44px; background: #dbeafe; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-weight: 700; color: #1d4ed8; font-size: 14px; }
    .roster-info { flex: 1; }
    .roster-name { font-weight: 500; }
    .roster-position { font-size: 12px; color: #16a34a; font-weight: 500; }
    .roster-stats { font-size: 12px; color: #6b7280; }

    /* Welcome Screen */
    .welcome { min-height: 100vh; display: flex; flex-direction: column; }
    .welcome-content { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px 24px; text-align: center; }
    .welcome-logo { font-size: 72px; margin-bottom: 16px; }
    .welcome h1 { color: #16a34a; font-size: 36px; font-weight: 700; }
    .welcome p { color: #6b7280; margin-top: 8px; }
    .welcome-features { text-align: left; margin-top: 40px; width: 100%; }
    .welcome-feature { display: flex; align-items: center; gap: 12px; padding: 12px 0; color: #374151; }
    .welcome-feature span:first-child { font-size: 24px; }
    .welcome-btns { padding: 24px; }

    /* Auth Screen */
    .auth-content { padding: 20px 24px; }
    .auth-header { text-align: center; margin-bottom: 24px; }
    .auth-header .logo { font-size: 48px; }
    .auth-header h2 { margin-top: 12px; font-size: 24px; }
    .auth-header p { color: #6b7280; margin-top: 8px; }
    .role-toggle { display: flex; gap: 12px; margin-bottom: 20px; }
    .role-btn { flex: 1; padding: 12px; border: 2px solid #e5e7eb; border-radius: 12px; background: white; cursor: pointer; font-size: 14px; font-weight: 500; }
    .role-btn.active { border-color: #16a34a; background: #f0fdf4; }
    .error-box { background: #fef2f2; border: 1px solid #fecaca; border-radius: 10px; padding: 12px 14px; color: #dc2626; font-size: 14px; margin-bottom: 16px; }
    .demo-box { background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 10px; padding: 14px; margin-top: 20px; font-size: 13px; color: #15803d; }
    .demo-box strong { color: #166534; }
    .auth-footer { padding: 20px 24px; border-top: 1px solid #e5e7eb; text-align: center; }
    .auth-footer span { color: #6b7280; }
    .link-btn { background: none; border: none; color: #16a34a; font-weight: 600; cursor: pointer; }
    .back-btn { background: none; border: none; color: #16a34a; font-weight: 500; cursor: pointer; font-size: 15px; padding: 16px 20px; }

    /* Chat Screen */
    .chat-screen { display: flex; flex-direction: column; min-height: 100vh; }
    .chat-header { background: linear-gradient(135deg, #16a34a 0%, #15803d 100%); padding: 16px 20px; display: flex; align-items: center; gap: 12px; color: white; }
    .chat-header-back { background: none; border: none; color: white; font-size: 20px; cursor: pointer; padding: 8px; }
    .chat-header-icon { width: 44px; height: 44px; background: rgba(255,255,255,0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 20px; }
    .chat-header-info h3 { font-weight: 600; }
    .chat-header-info p { font-size: 12px; opacity: 0.8; }
    .chat-messages { flex: 1; padding: 20px; background: #f9fafb; min-height: 400px; overflow-y: auto; }
    .message { max-width: 80%; padding: 10px 14px; border-radius: 18px; margin-bottom: 8px; }
    .message.mine { background: #16a34a; color: white; margin-left: auto; border-bottom-right-radius: 4px; }
    .message.other { background: white; color: #1f2937; border-bottom-left-radius: 4px; box-shadow: 0 1px 2px rgba(0,0,0,0.08); }
    .message-sender { font-size: 12px; font-weight: 600; margin-bottom: 4px; color: #16a34a; }
    .message-text { font-size: 15px; line-height: 1.4; }
    .message-time { font-size: 10px; opacity: 0.7; margin-top: 4px; text-align: right; }
    .chat-input { display: flex; gap: 12px; padding: 16px; background: white; border-top: 1px solid #e5e7eb; }
    .chat-input input { flex: 1; padding: 12px 16px; border: 1px solid #e5e7eb; border-radius: 24px; outline: none; font-size: 15px; }
    .chat-input button { background: #16a34a; color: white; border: none; border-radius: 24px; padding: 12px 20px; font-weight: 600; cursor: pointer; }

    /* Modal */
    .modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: flex-end; justify-content: center; z-index: 200; }
    .modal-content { background: white; border-radius: 24px 24px 0 0; padding: 24px; width: 100%; max-width: 430px; max-height: 90vh; overflow-y: auto; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .modal-header h3 { font-size: 20px; font-weight: 700; }
    .modal-close { background: #f3f4f6; border: none; border-radius: 20px; width: 36px; height: 36px; cursor: pointer; font-size: 18px; }
    .invite-box { background: #f0fdf4; border: 2px dashed #16a34a; border-radius: 12px; padding: 24px; text-align: center; margin-bottom: 20px; }
    .invite-label { font-size: 12px; color: #6b7280; text-transform: uppercase; letter-spacing: 1px; }
    .invite-code { font-size: 32px; font-weight: 700; color: #16a34a; letter-spacing: 3px; margin-top: 8px; }
    .invite-hint { font-size: 13px; color: #6b7280; margin-top: 12px; }

    /* Event Detail Modal */
    .event-detail-header { text-align: center; margin-bottom: 20px; }
    .event-detail-icon { width: 72px; height: 72px; border-radius: 18px; display: flex; align-items: center; justify-content: center; font-size: 36px; margin: 0 auto 12px; }
    .event-detail-icon.game { background: #ffedd5; }
    .event-detail-icon.practice { background: #dbeafe; }
    .event-detail-title { font-size: 22px; font-weight: 700; }
    .event-detail-date { color: #6b7280; margin-top: 4px; }
    .event-detail-section { background: #f9fafb; border-radius: 12px; padding: 16px; margin-bottom: 12px; }
    .event-detail-label { font-size: 12px; color: #9ca3af; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; }
    .event-detail-value { font-size: 16px; font-weight: 500; color: #1f2937; }
    .directions-btn { background: #4285f4; color: white; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .directions-btn:hover { background: #3367d6; }

    /* Carpool Styles */
    .carpool-group { background: white; border-radius: 14px; padding: 16px; margin-bottom: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
    .carpool-group-header { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
    .carpool-group-icon { width: 48px; height: 48px; background: #fef3c7; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px; }
    .carpool-group-info { flex: 1; }
    .carpool-group-name { font-weight: 600; font-size: 16px; }
    .carpool-group-members { font-size: 13px; color: #6b7280; }
    .carpool-members-list { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
    .carpool-member-chip { background: #f3f4f6; padding: 4px 10px; border-radius: 20px; font-size: 12px; color: #374151; }
    .carpool-member-chip.you { background: #dcfce7; color: #166534; }
    .ride-card { background: white; border-radius: 14px; padding: 16px; margin-bottom: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); border-left: 4px solid #16a34a; }
    .ride-card.full { border-left-color: #9ca3af; opacity: 0.7; }
    .ride-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
    .ride-event { font-weight: 600; font-size: 15px; }
    .ride-date { font-size: 13px; color: #6b7280; }
    .ride-driver { display: flex; align-items: center; gap: 8px; margin: 12px 0; padding: 10px; background: #f9fafb; border-radius: 10px; }
    .ride-driver-avatar { width: 36px; height: 36px; background: #dbeafe; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 16px; }
    .ride-driver-info { flex: 1; }
    .ride-driver-name { font-weight: 500; font-size: 14px; }
    .ride-driver-label { font-size: 11px; color: #6b7280; }
    .ride-seats { display: flex; align-items: center; gap: 8px; margin-bottom: 12px; }
    .ride-seats-icon { font-size: 18px; }
    .ride-seats-text { font-size: 13px; color: #374151; }
    .ride-seats-text span { font-weight: 600; color: #16a34a; }
    .ride-passengers { margin-bottom: 12px; }
    .ride-passengers-label { font-size: 12px; color: #9ca3af; margin-bottom: 6px; }
    .ride-passengers-list { display: flex; flex-wrap: wrap; gap: 6px; }
    .ride-passenger { background: #e0f2fe; padding: 4px 10px; border-radius: 20px; font-size: 12px; color: #0369a1; }
    .ride-passenger.you { background: #dcfce7; color: #166534; font-weight: 600; }
    .ride-actions { display: flex; gap: 8px; }
    .btn-join { background: #16a34a; color: white; flex: 1; }
    .btn-leave { background: #fef2f2; color: #dc2626; flex: 1; }
    .btn-cancel { background: #fee2e2; color: #dc2626; }
    .empty-state { text-align: center; padding: 40px 20px; color: #9ca3af; }
    .empty-state-icon { font-size: 48px; margin-bottom: 12px; }
    .empty-state-text { font-size: 14px; }
    .tab-buttons { display: flex; gap: 8px; margin-bottom: 16px; }
    .tab-btn { flex: 1; padding: 10px; border: none; border-radius: 10px; font-size: 14px; font-weight: 500; cursor: pointer; background: #f3f4f6; color: #6b7280; }
    .tab-btn.active { background: #16a34a; color: white; }
  </style>
</head>
<body>
  <div id="app" class="app"></div>

  <script>
    // ===== DATA STORAGE =====
    var Storage = {
      getData: function() {
        var saved = localStorage.getItem('teamkick_data');
        if (saved) return JSON.parse(saved);
        var defaultData = {
          users: [
            { id: 'coach-1', email: 'coach@teamkick.com', password: 'password123', name: 'Coach Mike', isCoach: true, teamId: 'team-1' },
            { id: 'parent-1', email: 'sarah@email.com', password: 'password123', name: 'Sarah Wilson', isCoach: false, teamId: 'team-1', playerId: 'player-1', address: '123 Oak Street, Cary, NC 27513' },
            { id: 'parent-2', email: 'david@email.com', password: 'password123', name: 'David Chen', isCoach: false, teamId: 'team-1', playerId: 'player-2', address: '456 Maple Avenue, Cary, NC 27513' },
            { id: 'parent-3', email: 'maria@email.com', password: 'password123', name: 'Maria Martinez', isCoach: false, teamId: 'team-1', playerId: 'player-3', address: '789 Pine Lane, Cary, NC 27513' }
          ],
          teams: [
            { id: 'team-1', name: 'Cary Lightning', code: 'LIGHT-2025', ageGroup: 'U10', season: 'Fall 2025', record: '4-1-2' }
          ],
          players: [
            { id: 'player-1', name: 'Emma Wilson', teamId: 'team-1', jersey: 7, position: 'Forward', goals: 5, assists: 3 },
            { id: 'player-2', name: 'Liam Chen', teamId: 'team-1', jersey: 10, position: 'Midfielder', goals: 3, assists: 7 },
            { id: 'player-3', name: 'Olivia Martinez', teamId: 'team-1', jersey: 3, position: 'Defender', goals: 1, assists: 2 },
            { id: 'player-4', name: 'Noah Johnson', teamId: 'team-1', jersey: 5, position: 'Goalkeeper', goals: 0, assists: 0 },
            { id: 'player-5', name: 'Ava Thompson', teamId: 'team-1', jersey: 11, position: 'Forward', goals: 4, assists: 2 }
          ],
          events: [
            { id: 'e1', teamId: 'team-1', type: 'game', title: 'vs Thunder FC', date: '2025-12-06', time: '10:00 AM', location: 'North Fields Complex', address: '1200 North Harrison Ave, Cary, NC 27513' },
            { id: 'e2', teamId: 'team-1', type: 'practice', title: 'Practice', date: '2025-12-03', time: '5:30 PM', location: 'Community Park', address: '316 N Academy St, Cary, NC 27513' },
            { id: 'e3', teamId: 'team-1', type: 'practice', title: 'Practice', date: '2025-12-05', time: '5:30 PM', location: 'Community Park', address: '316 N Academy St, Cary, NC 27513' },
            { id: 'e4', teamId: 'team-1', type: 'game', title: 'vs Storm United', date: '2025-12-13', time: '2:00 PM', location: 'Riverside Complex', address: '1500 Tryon Rd, Cary, NC 27511' }
          ],
          chats: [
            { id: 'chat-team', name: 'Team Chat', icon: 'üí¨', teamId: 'team-1', type: 'team' },
            { id: 'chat-carpool', name: 'Carpool Coordination', icon: 'üöó', teamId: 'team-1', type: 'carpool' },
            { id: 'chat-parents', name: 'Parents Lounge', icon: 'üë®‚Äçüë©‚Äçüëß', teamId: 'team-1', type: 'parents' },
            { id: 'chat-coaches', name: 'Coaches Only', icon: 'üèÜ', teamId: 'team-1', type: 'coaches' },
            { id: 'chat-cg-1', name: 'Neighborhood Crew Chat', icon: 'üöó', teamId: 'team-1', type: 'carpool-group', carpoolGroupId: 'cg-1', memberIds: ['parent-1', 'parent-2', 'parent-3'] }
          ],
          messages: [
            { id: 'm1', chatId: 'chat-team', oderId: 'coach-1', senderName: 'Coach Mike', text: 'Great practice today! Remember water bottles Saturday üí™', time: Date.now() - 3600000 },
            { id: 'm2', chatId: 'chat-team', oderId: 'parent-1', senderName: 'Sarah Wilson', text: 'Thanks coach! Emma is so excited!', time: Date.now() - 3000000 },
            { id: 'm3', chatId: 'chat-team', oderId: 'parent-2', senderName: 'David Chen', text: 'I can bring oranges for halftime üçä', time: Date.now() - 2400000 },
            { id: 'm4', chatId: 'chat-carpool', oderId: 'parent-3', senderName: 'Maria Martinez', text: 'Anyone need a ride Saturday?', time: Date.now() - 1800000 },
            { id: 'm5', chatId: 'chat-parents', oderId: 'parent-1', senderName: 'Sarah Wilson', text: 'Should we do a group gift for Coach Mike? üéÅ', time: Date.now() - 7200000 },
            { id: 'm6', chatId: 'chat-parents', oderId: 'parent-2', senderName: 'David Chen', text: 'Great idea! Count us in!', time: Date.now() - 6800000 },
            { id: 'm7', chatId: 'chat-cg-1', oderId: 'parent-1', senderName: 'Sarah Wilson', text: 'Hey neighbors! Ready to coordinate rides this season? üöó', time: Date.now() - 5000000 },
            { id: 'm8', chatId: 'chat-cg-1', oderId: 'parent-2', senderName: 'David Chen', text: 'Sounds great! I can drive on Saturdays', time: Date.now() - 4800000 }
          ],
          carpoolGroups: [
            { id: 'cg-1', teamId: 'team-1', name: 'Neighborhood Crew', creatorId: 'parent-1', memberIds: ['parent-1', 'parent-2', 'parent-3'], chatId: 'chat-cg-1' }
          ],
          rideOffers: [
            { id: 'ride-1', groupId: 'cg-1', eventId: 'e1', driverId: 'parent-1', driverName: 'Sarah Wilson', seats: 3, passengers: ['parent-2'] },
            { id: 'ride-2', groupId: 'cg-1', eventId: 'e2', driverId: 'parent-3', driverName: 'Maria Martinez', seats: 2, passengers: [] }
          ]
        };
        localStorage.setItem('teamkick_data', JSON.stringify(defaultData));
        return defaultData;
      },
      saveData: function(data) {
        localStorage.setItem('teamkick_data', JSON.stringify(data));
      },
      getUser: function() {
        var u = localStorage.getItem('teamkick_user');
        return u ? JSON.parse(u) : null;
      },
      setUser: function(user) {
        if (user) {
          localStorage.setItem('teamkick_user', JSON.stringify(user));
        } else {
          localStorage.removeItem('teamkick_user');
        }
      }
    };

    // ===== HELPERS =====
    function genId() {
      return Math.random().toString(36).substr(2, 9);
    }

    function formatDate(dateStr) {
      var d = new Date(dateStr + 'T12:00:00');
      return d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
    }

    function getMonthDay(dateStr) {
      var d = new Date(dateStr + 'T12:00:00');
      return {
        month: d.toLocaleDateString('en-US', { month: 'short' }).toUpperCase(),
        day: d.getDate()
      };
    }

    function formatTime(timestamp) {
      var d = new Date(timestamp);
      return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    function getDaysUntil(dateStr) {
      var today = new Date();
      today.setHours(0, 0, 0, 0);
      var eventDate = new Date(dateStr + 'T12:00:00');
      eventDate.setHours(0, 0, 0, 0);
      var diff = Math.ceil((eventDate - today) / 86400000);
      if (diff === 0) return 'Today';
      if (diff === 1) return 'Tomorrow';
      if (diff < 0) return 'Past';
      return 'In ' + diff + ' days';
    }

    // ===== APP STATE =====
    var currentUser = Storage.getUser();
    var currentScreen = 'welcome';
    var currentTab = 'home';
    var currentChat = null;
    var createAccountStep = 1;
    var createAccountIsCoach = false;
    var carpoolSubTab = 'rides'; // 'rides' or 'groups'

    // ===== RENDER FUNCTIONS =====
    function render() {
      var app = document.getElementById('app');

      if (!currentUser) {
        if (currentScreen === 'welcome') {
          app.innerHTML = renderWelcome();
        } else if (currentScreen === 'signin') {
          app.innerHTML = renderSignIn();
        } else if (currentScreen === 'create') {
          app.innerHTML = renderCreateAccount();
        }
      } else if (currentChat) {
        app.innerHTML = renderChatScreen();
      } else if (currentUser.isCoach) {
        app.innerHTML = renderCoachDashboard();
      } else {
        app.innerHTML = renderParentDashboard();
      }
    }

    function renderWelcome() {
      return '<div class="welcome">' +
        '<div class="welcome-content">' +
          '<div class="welcome-logo">‚öΩ</div>' +
          '<h1>TeamKick</h1>' +
          '<p>Youth soccer coordination made simple</p>' +
          '<div class="welcome-features">' +
            '<div class="welcome-feature"><span>üìÖ</span><span>Schedule games & practices</span></div>' +
            '<div class="welcome-feature"><span>üöó</span><span>Coordinate carpools</span></div>' +
            '<div class="welcome-feature"><span>üí¨</span><span>Team & parent group chats</span></div>' +
            '<div class="welcome-feature"><span>üìä</span><span>Track player stats</span></div>' +
          '</div>' +
        '</div>' +
        '<div class="welcome-btns">' +
          '<button class="btn btn-primary" onclick="goToSignIn()">Sign In</button>' +
          '<button class="btn btn-outline" onclick="goToCreateAccount()">Create Account</button>' +
        '</div>' +
      '</div>';
    }

    function renderSignIn() {
      return '<div>' +
        '<button class="back-btn" onclick="goToWelcome()">‚Üê Back</button>' +
        '<div class="auth-content">' +
          '<div class="auth-header">' +
            '<div class="logo">‚öΩ</div>' +
            '<h2>Welcome back!</h2>' +
            '<p>Sign in to your TeamKick account</p>' +
          '</div>' +
          '<div id="error-box" class="error-box hidden"></div>' +
          '<div class="role-toggle">' +
            '<button id="role-parent" class="role-btn active" onclick="selectRole(false)">üë®‚Äçüë©‚Äçüëß Parent</button>' +
            '<button id="role-coach" class="role-btn" onclick="selectRole(true)">üèÜ Coach</button>' +
          '</div>' +
          '<div class="input-group"><label>Email</label><input id="signin-email" class="input" type="email" placeholder="you@example.com"></div>' +
          '<div class="input-group"><label>Password</label><input id="signin-password" class="input" type="password" placeholder="Enter password"></div>' +
          '<button class="btn btn-primary" onclick="handleSignIn()">Sign In</button>' +
          '<div class="demo-box">' +
            '<strong>üîë Demo Accounts</strong><br>' +
            'Coach: coach@teamkick.com<br>' +
            'Parent: sarah@email.com<br>' +
            'Password: password123<br><br>' +
            'Team Code: LIGHT-2025' +
          '</div>' +
        '</div>' +
        '<div class="auth-footer">' +
          '<span>Don\'t have an account? </span>' +
          '<button class="link-btn" onclick="goToCreateAccount()">Create one</button>' +
        '</div>' +
      '</div>';
    }

    function renderCreateAccount() {
      if (createAccountStep === 1) {
        return '<div>' +
          '<button class="back-btn" onclick="goToWelcome()">‚Üê Back</button>' +
          '<div class="auth-content">' +
            '<div class="auth-header">' +
              '<h2>Create account</h2>' +
              '<p>Join TeamKick today</p>' +
            '</div>' +
            '<div id="error-box" class="error-box hidden"></div>' +
            '<div class="role-toggle">' +
              '<button id="role-parent" class="role-btn ' + (createAccountIsCoach ? '' : 'active') + '" onclick="selectCreateRole(false)">üë®‚Äçüë©‚Äçüëß Parent</button>' +
              '<button id="role-coach" class="role-btn ' + (createAccountIsCoach ? 'active' : '') + '" onclick="selectCreateRole(true)">üèÜ Coach</button>' +
            '</div>' +
            '<div class="input-group"><label>Your Name</label><input id="create-name" class="input" placeholder="John Smith"></div>' +
            '<div class="input-group"><label>Email</label><input id="create-email" class="input" type="email" placeholder="you@example.com"></div>' +
            '<div class="input-group"><label>Password</label><input id="create-password" class="input" type="password" placeholder="6+ characters"></div>' +
            '<button class="btn btn-primary" onclick="handleCreateStep1()">Continue</button>' +
          '</div>' +
          '<div class="auth-footer">' +
            '<span>Have an account? </span>' +
            '<button class="link-btn" onclick="goToSignIn()">Sign in</button>' +
          '</div>' +
        '</div>';
      } else {
        var content = createAccountIsCoach ?
          '<div class="input-group"><label>Team Name</label><input id="create-team" class="input" placeholder="Cary Lightning"></div>' +
          '<div class="input-group"><label>Age Group</label><select id="create-age" class="input"><option value="">Select</option><option>U6</option><option>U8</option><option>U10</option><option>U12</option><option>U14</option></select></div>'
          :
          '<div class="input-group"><label>Team Code</label><input id="create-code" class="input" placeholder="LIGHT-2025" style="text-transform:uppercase;letter-spacing:2px;font-weight:600"><span style="font-size:12px;color:#9ca3af">Ask your coach for this</span></div>' +
          '<div class="input-group"><label>Child\'s Name</label><input id="create-child" class="input" placeholder="Emma Wilson"></div>' +
          '<div class="input-group"><label>Your Home Address</label><input id="create-address" class="input" placeholder="123 Main St, City, NC 27513"><span style="font-size:12px;color:#9ca3af">Used for carpool coordination only</span></div>';

        return '<div>' +
          '<button class="back-btn" onclick="backToStep1()">‚Üê Back</button>' +
          '<div class="auth-content">' +
            '<div class="auth-header">' +
              '<h2>' + (createAccountIsCoach ? 'Create Team' : 'Join Team') + '</h2>' +
              '<p>' + (createAccountIsCoach ? 'Set up your team' : 'Enter team code from coach') + '</p>' +
            '</div>' +
            '<div id="error-box" class="error-box hidden"></div>' +
            content +
            '<button class="btn btn-primary" onclick="handleCreateStep2()">' + (createAccountIsCoach ? 'Create Team' : 'Join Team') + '</button>' +
          '</div>' +
        '</div>';
      }
    }

    function renderParentDashboard() {
      var data = Storage.getData();
      var team = data.teams.find(function(t) { return t.id === currentUser.teamId; });
      var myPlayer = data.players.find(function(p) { return p.id === currentUser.playerId; });
      var events = data.events.filter(function(e) { return e.teamId === currentUser.teamId; });
      var chats = data.chats.filter(function(c) { return c.teamId === currentUser.teamId && c.type !== 'coaches'; });
      var players = data.players.filter(function(p) { return p.teamId === currentUser.teamId; });

      var content = '';

      if (currentTab === 'home') {
        var eventsHtml = events.slice(0, 3).map(function(e) {
          return '<div class="card event-card">' +
            '<div class="event-icon ' + e.type + '">' + (e.type === 'game' ? '‚öΩ' : 'üèÉ') + '</div>' +
            '<div class="event-info">' +
              '<div class="event-title">' + e.title + '</div>' +
              '<div class="event-time">' + formatDate(e.date) + ' ‚Ä¢ ' + e.time + '</div>' +
              '<div class="event-location">üìç ' + e.location + '</div>' +
            '</div>' +
            '<div class="event-badge">' + getDaysUntil(e.date) + '</div>' +
            '<div class="event-actions">' +
              '<button class="directions-btn-small" onclick="event.stopPropagation(); getDirections(\'' + e.id + '\')">üó∫Ô∏è Get Directions</button>' +
            '</div>' +
          '</div>';
        }).join('');

        var playerCard = myPlayer ? '<div class="card player-card">' +
          '<div class="player-avatar">‚öΩ</div>' +
          '<div class="player-info">' +
            '<div class="player-name">' + myPlayer.name + '</div>' +
            '<div class="player-detail">#' + myPlayer.jersey + ' ‚Ä¢ ' + myPlayer.position + '</div>' +
          '</div>' +
          '<div class="player-stats">' +
            '<div class="player-stat"><div class="player-stat-num">' + myPlayer.goals + '</div><div class="player-stat-label">Goals</div></div>' +
            '<div class="player-stat"><div class="player-stat-num">' + myPlayer.assists + '</div><div class="player-stat-label">Assists</div></div>' +
          '</div>' +
        '</div>' : '';

        content = '<div class="hero">' +
          '<div class="hero-badge">' + (team ? team.ageGroup : '') + '</div>' +
          '<h2>' + (team ? team.name : '') + '</h2>' +
          '<p>' + (team ? team.season : '') + ' ‚Ä¢ Record: ' + (team ? team.record : '') + '</p>' +
        '</div>' +
        playerCard +
        '<h3 class="section-title">Upcoming Events</h3>' +
        eventsHtml +
        '<h3 class="section-title">Quick Actions</h3>' +
        '<div class="quick-grid">' +
          '<button class="quick-btn" onclick="openChat(\'chat-team\')"><span>üí¨</span><span>Team Chat</span></button>' +
          '<button class="quick-btn" onclick="openChat(\'chat-parents\')"><span>üë®‚Äçüë©‚Äçüëß</span><span>Parents</span></button>' +
          '<button class="quick-btn" onclick="openChat(\'chat-carpool\')"><span>üöó</span><span>Carpools</span></button>' +
          '<button class="quick-btn" onclick="switchTab(\'team\')"><span>üë•</span><span>Roster</span></button>' +
        '</div>';
      } else if (currentTab === 'schedule') {
        var scheduleHtml = events.map(function(e) {
          var md = getMonthDay(e.date);
          return '<div class="card schedule-card">' +
            '<div class="schedule-date"><div class="schedule-month">' + md.month + '</div><div class="schedule-day">' + md.day + '</div></div>' +
            '<div class="schedule-info">' +
              '<span class="schedule-type ' + e.type + '">' + e.type + '</span>' +
              '<div class="event-title">' + e.title + '</div>' +
              '<div class="event-time">' + e.time + ' ‚Ä¢ ' + e.location + '</div>' +
            '</div>' +
            '<button class="directions-btn-small" onclick="getDirections(\'' + e.id + '\')" style="flex:none;width:auto">üó∫Ô∏è</button>' +
          '</div>';
        }).join('');
        content = '<h2 style="margin-bottom:16px">Schedule</h2>' + scheduleHtml;
      } else if (currentTab === 'carpool') {
        content = renderCarpoolTab(data);
      } else if (currentTab === 'team') {
        var rosterHtml = players.map(function(p) {
          var isMine = currentUser.playerId === p.id;
          return '<div class="card roster-card" style="' + (isMine ? 'background:#f0fdf4' : '') + '">' +
            '<div class="jersey">#' + p.jersey + '</div>' +
            '<div class="roster-info">' +
              '<div class="roster-name">' + p.name + (isMine ? ' <span style="font-size:10px;background:#dcfce7;color:#166534;padding:2px 6px;border-radius:4px">Your child</span>' : '') + '</div>' +
              '<div class="roster-position">' + p.position + '</div>' +
            '</div>' +
            '<div class="roster-stats">' + p.goals + 'G ' + p.assists + 'A</div>' +
          '</div>';
        }).join('');
        content = '<h2 style="margin-bottom:16px">Team Roster</h2>' + rosterHtml;
      }

      return '<div class="header">' +
        '<h1>TeamKick</h1>' +
        '<button class="avatar-btn" onclick="logout()">üë§</button>' +
      '</div>' +
      '<div class="content">' + content + '</div>' +
      '<div class="nav">' +
        '<button class="nav-item ' + (currentTab === 'home' ? 'active' : '') + '" onclick="switchTab(\'home\')"><span>üè†</span><span>Home</span></button>' +
        '<button class="nav-item ' + (currentTab === 'schedule' ? 'active' : '') + '" onclick="switchTab(\'schedule\')"><span>üìÖ</span><span>Schedule</span></button>' +
        '<button class="nav-item ' + (currentTab === 'carpool' ? 'active' : '') + '" onclick="switchTab(\'carpool\')"><span>üöó</span><span>Carpool</span></button>' +
        '<button class="nav-item ' + (currentTab === 'team' ? 'active' : '') + '" onclick="switchTab(\'team\')"><span>üë•</span><span>Team</span></button>' +
      '</div>';
    }

    function renderCoachDashboard() {
      var data = Storage.getData();
      var team = data.teams.find(function(t) { return t.id === currentUser.teamId; });
      var events = data.events.filter(function(e) { return e.teamId === currentUser.teamId; });
      var chats = data.chats.filter(function(c) { return c.teamId === currentUser.teamId; });
      var players = data.players.filter(function(p) { return p.teamId === currentUser.teamId; });

      var content = '';

      if (currentTab === 'home') {
        var eventsHtml = events.slice(0, 3).map(function(e) {
          return '<div class="card event-card">' +
            '<div class="event-icon ' + e.type + '">' + (e.type === 'game' ? '‚öΩ' : 'üèÉ') + '</div>' +
            '<div class="event-info">' +
              '<div class="event-title">' + e.title + '</div>' +
              '<div class="event-time">' + formatDate(e.date) + ' ‚Ä¢ ' + e.time + '</div>' +
              '<div class="event-location">üìç ' + e.location + '</div>' +
            '</div>' +
            '<div class="event-badge">' + getDaysUntil(e.date) + '</div>' +
            '<div class="event-actions">' +
              '<button class="directions-btn-small" onclick="event.stopPropagation(); getDirections(\'' + e.id + '\')">üó∫Ô∏è Get Directions</button>' +
            '</div>' +
          '</div>';
        }).join('');

        content = '<div class="hero blue">' +
          '<div class="hero-badge">' + (team ? team.ageGroup : '') + '</div>' +
          '<h2>' + (team ? team.name : '') + '</h2>' +
          '<p>' + (team ? team.season : '') + ' ‚Ä¢ Record: ' + (team ? team.record : '') + '</p>' +
          '<div class="hero-stats">' +
            '<div class="hero-stat"><div class="hero-stat-num">' + players.length + '</div><div class="hero-stat-label">Players</div></div>' +
            '<div class="hero-stat"><div class="hero-stat-num">' + events.length + '</div><div class="hero-stat-label">Events</div></div>' +
          '</div>' +
        '</div>' +
        '<h3 class="section-title">Quick Actions</h3>' +
        '<div class="quick-grid">' +
          '<button class="quick-btn" onclick="showAddEvent()"><span>üìÖ</span><span>Add Event</span></button>' +
          '<button class="quick-btn" onclick="showAddPlayer()"><span>‚ûï</span><span>Add Player</span></button>' +
          '<button class="quick-btn" onclick="showInvite()"><span>‚úâÔ∏è</span><span>Invite</span></button>' +
          '<button class="quick-btn" onclick="switchTab(\'chat\')"><span>üí¨</span><span>Chats</span></button>' +
        '</div>' +
        '<h3 class="section-title">Upcoming Events</h3>' +
        eventsHtml;
      } else if (currentTab === 'team') {
        var rosterHtml = players.map(function(p) {
          return '<div class="card roster-card">' +
            '<div class="jersey">#' + p.jersey + '</div>' +
            '<div class="roster-info">' +
              '<div class="roster-name">' + p.name + '</div>' +
              '<div class="roster-position">' + p.position + '</div>' +
            '</div>' +
            '<button class="btn btn-danger btn-small" onclick="removePlayer(\'' + p.id + '\')">‚úï</button>' +
          '</div>';
        }).join('');
        content = '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h2>Team Roster</h2><button class="btn btn-primary btn-small" onclick="showAddPlayer()">+ Add</button></div>' + rosterHtml;
      } else if (currentTab === 'schedule') {
        var scheduleHtml = events.map(function(e) {
          var md = getMonthDay(e.date);
          return '<div class="card schedule-card">' +
            '<div class="schedule-date"><div class="schedule-month">' + md.month + '</div><div class="schedule-day">' + md.day + '</div></div>' +
            '<div class="schedule-info">' +
              '<span class="schedule-type ' + e.type + '">' + e.type + '</span>' +
              '<div class="event-title">' + e.title + '</div>' +
              '<div class="event-time">' + e.time + ' ‚Ä¢ ' + e.location + '</div>' +
            '</div>' +
            '<button class="directions-btn-small" onclick="getDirections(\'' + e.id + '\')" style="flex:none;width:auto">üó∫Ô∏è</button>' +
          '</div>';
        }).join('');
        content = '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h2>Schedule</h2><button class="btn btn-primary btn-small" onclick="showAddEvent()">+ Add</button></div>' + scheduleHtml;
      } else if (currentTab === 'chat') {
        var chatsHtml = chats.map(function(c) {
          return '<div class="chat-item" onclick="openChat(\'' + c.id + '\')">' +
            '<div class="chat-icon">' + c.icon + '</div>' +
            '<div class="chat-info">' +
              '<div class="chat-name">' + c.name + '</div>' +
              '<div class="chat-preview">Tap to open</div>' +
            '</div>' +
          '</div>';
        }).join('');
        content = '<h2 style="margin-bottom:16px">Group Chats</h2>' + chatsHtml;
      }

      return '<div class="header">' +
        '<h1>TeamKick</h1>' +
        '<span class="coach-badge">üèÜ Coach</span>' +
        '<button class="avatar-btn" onclick="logout()">üèÜ</button>' +
      '</div>' +
      '<div class="content">' + content + '</div>' +
      '<div class="nav">' +
        '<button class="nav-item ' + (currentTab === 'home' ? 'active' : '') + '" onclick="switchTab(\'home\')"><span>üè†</span><span>Home</span></button>' +
        '<button class="nav-item ' + (currentTab === 'team' ? 'active' : '') + '" onclick="switchTab(\'team\')"><span>üë•</span><span>Team</span></button>' +
        '<button class="nav-item ' + (currentTab === 'schedule' ? 'active' : '') + '" onclick="switchTab(\'schedule\')"><span>üìÖ</span><span>Schedule</span></button>' +
        '<button class="nav-item ' + (currentTab === 'chat' ? 'active' : '') + '" onclick="switchTab(\'chat\')"><span>üí¨</span><span>Chats</span></button>' +
      '</div>';
    }

    function renderChatScreen() {
      var data = Storage.getData();
      var chat = data.chats.find(function(c) { return c.id === currentChat; });
      var messages = data.messages.filter(function(m) { return m.chatId === currentChat; }).sort(function(a, b) { return a.time - b.time; });

      var messagesHtml = messages.map(function(m) {
        var isMine = m.oderId === currentUser.id;
        return '<div style="display:flex;justify-content:' + (isMine ? 'flex-end' : 'flex-start') + '">' +
          '<div class="message ' + (isMine ? 'mine' : 'other') + '">' +
            (isMine ? '' : '<div class="message-sender">' + m.senderName + '</div>') +
            '<div class="message-text">' + m.text + '</div>' +
            '<div class="message-time">' + formatTime(m.time) + '</div>' +
          '</div>' +
        '</div>';
      }).join('');

      return '<div class="chat-screen">' +
        '<div class="chat-header">' +
          '<button class="chat-header-back" onclick="closeChat()">‚Üê</button>' +
          '<div class="chat-header-icon">' + (chat ? chat.icon : '') + '</div>' +
          '<div class="chat-header-info"><h3>' + (chat ? chat.name : '') + '</h3></div>' +
        '</div>' +
        '<div class="chat-messages" id="chat-messages">' + messagesHtml + '</div>' +
        '<div class="chat-input">' +
          '<input id="chat-input" placeholder="Type a message..." onkeypress="if(event.key===\'Enter\')sendMessage()">' +
          '<button onclick="sendMessage()">Send</button>' +
        '</div>' +
      '</div>';
    }

    // ===== CARPOOL TAB =====
    function renderCarpoolTab(data) {
      var myGroups = (data.carpoolGroups || []).filter(function(g) {
        return g.teamId === currentUser.teamId && g.memberIds.indexOf(currentUser.id) !== -1;
      });
      var allGroupIds = myGroups.map(function(g) { return g.id; });
      var myRides = (data.rideOffers || []).filter(function(r) {
        return allGroupIds.indexOf(r.groupId) !== -1;
      });
      var events = data.events.filter(function(e) { return e.teamId === currentUser.teamId; });
      var users = data.users;

      var tabButtons = '<div class="tab-buttons">' +
        '<button class="tab-btn ' + (carpoolSubTab === 'rides' ? 'active' : '') + '" onclick="switchCarpoolTab(\'rides\')">üöó Rides</button>' +
        '<button class="tab-btn ' + (carpoolSubTab === 'groups' ? 'active' : '') + '" onclick="switchCarpoolTab(\'groups\')">üë• My Groups</button>' +
      '</div>';

      if (carpoolSubTab === 'groups') {
        var groupsHtml = myGroups.length === 0 ?
          '<div class="empty-state"><div class="empty-state-icon">üë•</div><div class="empty-state-text">No carpool groups yet.<br>Create one to start coordinating rides!</div></div>' :
          myGroups.map(function(g) {
            var memberNames = g.memberIds.map(function(mid) {
              var u = users.find(function(usr) { return usr.id === mid; });
              return u ? (mid === currentUser.id ? 'You' : u.name.split(' ')[0]) : 'Unknown';
            });
            var chatId = g.chatId || '';
            return '<div class="carpool-group">' +
              '<div class="carpool-group-header">' +
                '<div class="carpool-group-icon">üöó</div>' +
                '<div class="carpool-group-info">' +
                  '<div class="carpool-group-name">' + g.name + '</div>' +
                  '<div class="carpool-group-members">' + g.memberIds.length + ' members</div>' +
                '</div>' +
                (chatId ? '<button class="btn btn-primary btn-small" onclick="openChat(\'' + chatId + '\')" style="padding:8px 12px">üí¨</button>' : '') +
              '</div>' +
              '<div class="carpool-members-list">' +
                memberNames.map(function(n) {
                  return '<span class="carpool-member-chip' + (n === 'You' ? ' you' : '') + '">' + n + '</span>';
                }).join('') +
              '</div>' +
              '<div style="display:flex;gap:8px;margin-top:12px">' +
                (chatId ? '<button class="btn btn-outline btn-small" onclick="openChat(\'' + chatId + '\')" style="flex:1">üí¨ Group Chat</button>' : '') +
                (g.creatorId === currentUser.id ? '<button class="btn btn-outline btn-small" onclick="showInviteToGroup(\'' + g.id + '\')" style="flex:1">+ Invite</button>' : '') +
              '</div>' +
            '</div>';
          }).join('');

        return '<h2 style="margin-bottom:16px">Carpool</h2>' + tabButtons +
          '<button class="btn btn-primary" onclick="showCreateGroup()">+ Create New Group</button>' +
          '<h3 class="section-title">Your Groups</h3>' + groupsHtml;
      } else {
        // Rides tab
        var ridesHtml = myRides.length === 0 ?
          '<div class="empty-state"><div class="empty-state-icon">üöó</div><div class="empty-state-text">No rides available.<br>Join a carpool group or offer a ride!</div></div>' :
          myRides.map(function(r) {
            var event = events.find(function(ev) { return ev.id === r.eventId; });
            if (!event) return '';
            var seatsLeft = r.seats - r.passengers.length;
            var isFull = seatsLeft <= 0;
            var isDriver = r.driverId === currentUser.id;
            var isPassenger = r.passengers.indexOf(currentUser.id) !== -1;
            var passengerNames = r.passengers.map(function(pid) {
              var u = users.find(function(usr) { return usr.id === pid; });
              return u ? (pid === currentUser.id ? 'You' : u.name.split(' ')[0]) : 'Unknown';
            });

            var actionBtn = '';
            var routeBtn = '';
            if (isDriver) {
              actionBtn = '<button class="btn btn-small btn-cancel" onclick="cancelRide(\'' + r.id + '\')">Cancel Ride</button>';
              if (r.passengers.length > 0) {
                routeBtn = '<button class="btn btn-small directions-btn-small" onclick="showRoutePlanner(\'' + r.id + '\')" style="flex:1">üó∫Ô∏è Plan Route</button>';
              }
            } else if (isPassenger) {
              actionBtn = '<button class="btn btn-small btn-leave" onclick="leaveRide(\'' + r.id + '\')">Leave Ride</button>';
            } else if (!isFull) {
              actionBtn = '<button class="btn btn-small btn-join" onclick="joinRide(\'' + r.id + '\')">Join Ride</button>';
            }

            return '<div class="ride-card' + (isFull && !isPassenger && !isDriver ? ' full' : '') + '">' +
              '<div class="ride-header">' +
                '<div>' +
                  '<div class="ride-event">' + (event.type === 'game' ? '‚öΩ ' : 'üèÉ ') + event.title + '</div>' +
                  '<div class="ride-date">' + formatDate(event.date) + ' ‚Ä¢ ' + event.time + '</div>' +
                '</div>' +
              '</div>' +
              '<div class="ride-driver">' +
                '<div class="ride-driver-avatar">' + (isDriver ? 'üë§' : 'üöò') + '</div>' +
                '<div class="ride-driver-info">' +
                  '<div class="ride-driver-name">' + (isDriver ? 'You\'re driving' : r.driverName) + '</div>' +
                  '<div class="ride-driver-label">Driver</div>' +
                '</div>' +
              '</div>' +
              '<div class="ride-seats">' +
                '<span class="ride-seats-icon">üí∫</span>' +
                '<span class="ride-seats-text"><span>' + seatsLeft + '</span> of ' + r.seats + ' seats available</span>' +
              '</div>' +
              (r.passengers.length > 0 ? '<div class="ride-passengers">' +
                '<div class="ride-passengers-label">Passengers:</div>' +
                '<div class="ride-passengers-list">' +
                  passengerNames.map(function(n) {
                    return '<span class="ride-passenger' + (n === 'You' ? ' you' : '') + '">' + n + '</span>';
                  }).join('') +
                '</div>' +
              '</div>' : '') +
              '<div class="ride-actions">' + routeBtn + actionBtn + '</div>' +
            '</div>';
          }).join('');

        return '<h2 style="margin-bottom:16px">Carpool</h2>' + tabButtons +
          '<button class="btn btn-primary" onclick="showOfferRide()">+ Offer a Ride</button>' +
          '<h3 class="section-title">Available Rides</h3>' + ridesHtml;
      }
    }

    function switchCarpoolTab(tab) {
      carpoolSubTab = tab;
      render();
    }

    // ===== EVENT HANDLERS =====
    var signInIsCoach = false;

    function goToWelcome() { currentScreen = 'welcome'; render(); }
    function goToSignIn() { currentScreen = 'signin'; render(); }
    function goToCreateAccount() { currentScreen = 'create'; createAccountStep = 1; render(); }

    function selectRole(isCoach) {
      signInIsCoach = isCoach;
      document.getElementById('role-parent').className = 'role-btn' + (isCoach ? '' : ' active');
      document.getElementById('role-coach').className = 'role-btn' + (isCoach ? ' active' : '');
    }

    function selectCreateRole(isCoach) {
      createAccountIsCoach = isCoach;
      render();
    }

    function backToStep1() {
      createAccountStep = 1;
      render();
    }

    function showError(msg) {
      var box = document.getElementById('error-box');
      box.textContent = msg;
      box.className = 'error-box';
    }

    function handleSignIn() {
      var email = document.getElementById('signin-email').value;
      var password = document.getElementById('signin-password').value;
      if (!email || !password) { showError('Please fill in all fields'); return; }
      var data = Storage.getData();
      var user = data.users.find(function(u) { return u.email.toLowerCase() === email.toLowerCase() && u.password === password; });
      if (!user) { showError('Invalid email or password'); return; }
      if (user.isCoach !== signInIsCoach) { showError('Wrong account type selected'); return; }
      currentUser = user;
      Storage.setUser(user);
      currentTab = 'home';
      render();
    }

    var createFormData = {};

    function handleCreateStep1() {
      var name = document.getElementById('create-name').value;
      var email = document.getElementById('create-email').value;
      var password = document.getElementById('create-password').value;
      if (!name || !email || !password) { showError('Please fill all fields'); return; }
      if (password.length < 6) { showError('Password must be 6+ characters'); return; }
      var data = Storage.getData();
      if (data.users.find(function(u) { return u.email.toLowerCase() === email.toLowerCase(); })) { showError('Email already registered'); return; }
      createFormData = { name: name, email: email, password: password };
      createAccountStep = 2;
      render();
    }

    function handleCreateStep2() {
      var data = Storage.getData();
      if (createAccountIsCoach) {
        var teamName = document.getElementById('create-team').value;
        if (!teamName) { showError('Enter team name'); return; }
        var teamId = genId();
        var userId = genId();
        var code = teamName.replace(/\s+/g, '').substring(0, 5).toUpperCase() + '-2025';
        data.teams.push({ id: teamId, name: teamName, code: code, ageGroup: 'U10', season: 'Fall 2025', record: '0-0-0' });
        data.chats.push(
          { id: 'chat-team-' + teamId, name: 'Team Chat', icon: 'üí¨', teamId: teamId, type: 'team' },
          { id: 'chat-carpool-' + teamId, name: 'Carpool', icon: 'üöó', teamId: teamId, type: 'carpool' },
          { id: 'chat-parents-' + teamId, name: 'Parents Lounge', icon: 'üë®‚Äçüë©‚Äçüëß', teamId: teamId, type: 'parents' },
          { id: 'chat-coaches-' + teamId, name: 'Coaches Only', icon: 'üèÜ', teamId: teamId, type: 'coaches' }
        );
        var user = { id: userId, email: createFormData.email, password: createFormData.password, name: createFormData.name, isCoach: true, teamId: teamId };
        data.users.push(user);
        Storage.saveData(data);
        currentUser = user;
        Storage.setUser(user);
        currentTab = 'home';
        render();
      } else {
        var code = document.getElementById('create-code').value;
        var childName = document.getElementById('create-child').value;
        var address = document.getElementById('create-address').value;
        if (!code || !childName) { showError('Please fill all fields'); return; }
        var team = data.teams.find(function(t) { return t.code.toUpperCase() === code.toUpperCase(); });
        if (!team) { showError('Invalid team code'); return; }
        var userId = genId();
        var playerId = genId();
        data.players.push({ id: playerId, name: childName, teamId: team.id, jersey: Math.floor(Math.random() * 20) + 1, position: 'TBD', goals: 0, assists: 0 });
        var user = { id: userId, email: createFormData.email, password: createFormData.password, name: createFormData.name, isCoach: false, teamId: team.id, playerId: playerId, address: address || '' };
        data.users.push(user);
        Storage.saveData(data);
        currentUser = user;
        Storage.setUser(user);
        currentTab = 'home';
        render();
      }
    }

    function switchTab(tab) {
      currentTab = tab;
      render();
    }

    function logout() {
      Storage.setUser(null);
      currentUser = null;
      currentScreen = 'welcome';
      currentTab = 'home';
      render();
    }

    function openChat(chatId) {
      currentChat = chatId;
      render();
      setTimeout(function() {
        var el = document.getElementById('chat-messages');
        if (el) el.scrollTop = el.scrollHeight;
      }, 50);
    }

    function closeChat() {
      currentChat = null;
      render();
    }

    function sendMessage() {
      var input = document.getElementById('chat-input');
      var text = input.value.trim();
      if (!text) return;
      var data = Storage.getData();
      data.messages.push({
        id: genId(),
        chatId: currentChat,
        oderId: currentUser.id,
        senderName: currentUser.name,
        text: text,
        time: Date.now()
      });
      Storage.saveData(data);
      input.value = '';
      render();
      setTimeout(function() {
        var el = document.getElementById('chat-messages');
        if (el) el.scrollTop = el.scrollHeight;
      }, 50);
    }

    function showAddPlayer() {
      var modal = document.createElement('div');
      modal.className = 'modal';
      modal.id = 'modal';
      modal.innerHTML = '<div class="modal-content">' +
        '<div class="modal-header"><h3>Add Player</h3><button class="modal-close" onclick="closeModal()">‚úï</button></div>' +
        '<div class="input-group"><label>Player Name</label><input id="new-player-name" class="input" placeholder="Emma Wilson"></div>' +
        '<div class="input-group"><label>Position</label><select id="new-player-pos" class="input"><option value="TBD">Select</option><option>Forward</option><option>Midfielder</option><option>Defender</option><option>Goalkeeper</option></select></div>' +
        '<div class="input-group"><label>Jersey #</label><input id="new-player-jersey" class="input" type="number" placeholder="7"></div>' +
        '<button class="btn btn-primary" onclick="addPlayer()">Add Player</button>' +
      '</div>';
      document.body.appendChild(modal);
    }

    function addPlayer() {
      var name = document.getElementById('new-player-name').value;
      var pos = document.getElementById('new-player-pos').value;
      var jersey = document.getElementById('new-player-jersey').value;
      if (!name) return;
      var data = Storage.getData();
      data.players.push({
        id: genId(),
        name: name,
        teamId: currentUser.teamId,
        jersey: parseInt(jersey) || Math.floor(Math.random() * 20) + 1,
        position: pos || 'TBD',
        goals: 0,
        assists: 0
      });
      Storage.saveData(data);
      closeModal();
      render();
    }

    function removePlayer(id) {
      var data = Storage.getData();
      data.players = data.players.filter(function(p) { return p.id !== id; });
      Storage.saveData(data);
      render();
    }

    function showAddEvent() {
      var modal = document.createElement('div');
      modal.className = 'modal';
      modal.id = 'modal';
      modal.innerHTML = '<div class="modal-content">' +
        '<div class="modal-header"><h3>Add Event</h3><button class="modal-close" onclick="closeModal()">‚úï</button></div>' +
        '<div class="input-group"><label>Type</label><select id="new-event-type" class="input"><option value="game">‚öΩ Game</option><option value="practice">üèÉ Practice</option></select></div>' +
        '<div class="input-group"><label>Title</label><input id="new-event-title" class="input" placeholder="vs Thunder FC"></div>' +
        '<div class="input-group"><label>Date</label><input id="new-event-date" class="input" type="date"></div>' +
        '<div class="input-group"><label>Time</label><input id="new-event-time" class="input" type="time"></div>' +
        '<div class="input-group"><label>Location Name</label><input id="new-event-loc" class="input" placeholder="North Fields Complex"></div>' +
        '<div class="input-group"><label>Address (for directions)</label><input id="new-event-address" class="input" placeholder="123 Main St, City, State 12345"></div>' +
        '<button class="btn btn-primary" onclick="addEvent()">Create Event</button>' +
      '</div>';
      document.body.appendChild(modal);
    }

    function addEvent() {
      var type = document.getElementById('new-event-type').value;
      var title = document.getElementById('new-event-title').value || (type === 'game' ? 'Game' : 'Practice');
      var date = document.getElementById('new-event-date').value;
      var time = document.getElementById('new-event-time').value;
      var loc = document.getElementById('new-event-loc').value;
      var address = document.getElementById('new-event-address').value;
      if (!date || !time || !loc) return;
      var data = Storage.getData();
      data.events.push({
        id: genId(),
        teamId: currentUser.teamId,
        type: type,
        title: title,
        date: date,
        time: time,
        location: loc,
        address: address || ''
      });
      Storage.saveData(data);
      closeModal();
      render();
    }

    function showInvite() {
      var data = Storage.getData();
      var team = data.teams.find(function(t) { return t.id === currentUser.teamId; });
      var modal = document.createElement('div');
      modal.className = 'modal';
      modal.id = 'modal';
      modal.innerHTML = '<div class="modal-content">' +
        '<div class="modal-header"><h3>Invite Parents</h3><button class="modal-close" onclick="closeModal()">‚úï</button></div>' +
        '<div class="invite-box">' +
          '<div class="invite-label">Team Code</div>' +
          '<div class="invite-code">' + (team ? team.code : '') + '</div>' +
          '<div class="invite-hint">Share this code with parents to join</div>' +
        '</div>' +
        '<button class="btn btn-primary" onclick="closeModal()">Done</button>' +
      '</div>';
      document.body.appendChild(modal);
    }

    function closeModal() {
      var modal = document.getElementById('modal');
      if (modal) modal.remove();
    }

    function showEventDetail(eventId) {
      var data = Storage.getData();
      var event = data.events.find(function(e) { return e.id === eventId; });
      if (!event) return;

      var modal = document.createElement('div');
      modal.className = 'modal';
      modal.id = 'modal';
      modal.innerHTML = '<div class="modal-content">' +
        '<div class="modal-header"><h3>Event Details</h3><button class="modal-close" onclick="closeModal()">‚úï</button></div>' +
        '<div class="event-detail-header">' +
          '<div class="event-detail-icon ' + event.type + '">' + (event.type === 'game' ? '‚öΩ' : 'üèÉ') + '</div>' +
          '<div class="event-detail-title">' + event.title + '</div>' +
          '<div class="event-detail-date">' + formatDate(event.date) + '</div>' +
        '</div>' +
        '<div class="event-detail-section">' +
          '<div class="event-detail-label">Time</div>' +
          '<div class="event-detail-value">üïê ' + event.time + '</div>' +
        '</div>' +
        '<div class="event-detail-section">' +
          '<div class="event-detail-label">Location</div>' +
          '<div class="event-detail-value">üìç ' + event.location + '</div>' +
          (event.address ? '<div style="font-size:13px;color:#6b7280;margin-top:4px">' + event.address + '</div>' : '') +
        '</div>' +
        '<button class="btn directions-btn" onclick="getDirections(\'' + eventId + '\')">' +
          '<span>üó∫Ô∏è</span> Get Directions' +
        '</button>' +
        '<button class="btn btn-outline" onclick="closeModal()">Close</button>' +
      '</div>';
      document.body.appendChild(modal);
    }

    function getDirections(eventId) {
      var data = Storage.getData();
      var event = data.events.find(function(e) { return e.id === eventId; });
      if (!event) return;

      // Use the address if available, otherwise use the location name
      var destination = event.address || event.location;

      // Encode the destination for URL
      var encodedDestination = encodeURIComponent(destination);

      // Open Google Maps directions in a new tab
      // This will use the user's current location as the starting point
      var mapsUrl = 'https://www.google.com/maps/dir/?api=1&destination=' + encodedDestination;

      window.open(mapsUrl, '_blank');
    }

    // ===== CARPOOL FUNCTIONS =====
    function showCreateGroup() {
      var data = Storage.getData();
      var teamParents = data.users.filter(function(u) {
        return u.teamId === currentUser.teamId && !u.isCoach && u.id !== currentUser.id;
      });

      var parentsCheckboxes = teamParents.map(function(p) {
        return '<label style="display:flex;align-items:center;gap:8px;padding:8px 0;border-bottom:1px solid #f3f4f6">' +
          '<input type="checkbox" class="group-member-check" value="' + p.id + '" style="width:20px;height:20px">' +
          '<span>' + p.name + '</span>' +
        '</label>';
      }).join('');

      var modal = document.createElement('div');
      modal.className = 'modal';
      modal.id = 'modal';
      modal.innerHTML = '<div class="modal-content">' +
        '<div class="modal-header"><h3>Create Carpool Group</h3><button class="modal-close" onclick="closeModal()">‚úï</button></div>' +
        '<p style="font-size:13px;color:#6b7280;margin-bottom:16px">Create a group with parents you trust for carpooling. Only group members can see and join each other\'s rides.</p>' +
        '<div class="input-group"><label>Group Name</label><input id="new-group-name" class="input" placeholder="e.g. Neighborhood Crew"></div>' +
        '<div class="input-group"><label>Select Parents to Invite</label>' +
          '<div style="max-height:200px;overflow-y:auto;border:1px solid #e5e7eb;border-radius:10px;padding:8px">' +
            (parentsCheckboxes || '<p style="color:#9ca3af;text-align:center;padding:20px">No other parents on this team yet</p>') +
          '</div>' +
        '</div>' +
        '<button class="btn btn-primary" onclick="createGroup()">Create Group</button>' +
      '</div>';
      document.body.appendChild(modal);
    }

    function createGroup() {
      var name = document.getElementById('new-group-name').value;
      if (!name) { alert('Please enter a group name'); return; }

      var checkboxes = document.querySelectorAll('.group-member-check:checked');
      var memberIds = [currentUser.id];
      checkboxes.forEach(function(cb) {
        memberIds.push(cb.value);
      });

      var data = Storage.getData();
      if (!data.carpoolGroups) data.carpoolGroups = [];

      var groupId = genId();
      var chatId = 'chat-carpool-group-' + groupId;

      // Create the carpool group
      data.carpoolGroups.push({
        id: groupId,
        teamId: currentUser.teamId,
        name: name,
        creatorId: currentUser.id,
        memberIds: memberIds,
        chatId: chatId
      });

      // Create a group chat for this carpool group
      if (!data.chats) data.chats = [];
      data.chats.push({
        id: chatId,
        name: name + ' Chat',
        icon: 'üöó',
        teamId: currentUser.teamId,
        type: 'carpool-group',
        carpoolGroupId: groupId,
        memberIds: memberIds
      });

      // Add a welcome message
      if (!data.messages) data.messages = [];
      data.messages.push({
        id: genId(),
        chatId: chatId,
        oderId: currentUser.id,
        senderName: currentUser.name,
        text: 'Welcome to the ' + name + ' carpool group chat! üöó',
        time: Date.now()
      });

      Storage.saveData(data);
      closeModal();
      render();
    }

    function showInviteToGroup(groupId) {
      var data = Storage.getData();
      var group = data.carpoolGroups.find(function(g) { return g.id === groupId; });
      if (!group) return;

      var teamParents = data.users.filter(function(u) {
        return u.teamId === currentUser.teamId && !u.isCoach && group.memberIds.indexOf(u.id) === -1;
      });

      var parentsCheckboxes = teamParents.map(function(p) {
        return '<label style="display:flex;align-items:center;gap:8px;padding:8px 0;border-bottom:1px solid #f3f4f6">' +
          '<input type="checkbox" class="invite-member-check" value="' + p.id + '" style="width:20px;height:20px">' +
          '<span>' + p.name + '</span>' +
        '</label>';
      }).join('');

      var modal = document.createElement('div');
      modal.className = 'modal';
      modal.id = 'modal';
      modal.innerHTML = '<div class="modal-content">' +
        '<div class="modal-header"><h3>Invite to ' + group.name + '</h3><button class="modal-close" onclick="closeModal()">‚úï</button></div>' +
        '<div class="input-group"><label>Select Parents to Add</label>' +
          '<div style="max-height:200px;overflow-y:auto;border:1px solid #e5e7eb;border-radius:10px;padding:8px">' +
            (parentsCheckboxes || '<p style="color:#9ca3af;text-align:center;padding:20px">All team parents are already in this group</p>') +
          '</div>' +
        '</div>' +
        '<button class="btn btn-primary" onclick="addToGroup(\'' + groupId + '\')">Add to Group</button>' +
      '</div>';
      document.body.appendChild(modal);
    }

    function addToGroup(groupId) {
      var checkboxes = document.querySelectorAll('.invite-member-check:checked');
      if (checkboxes.length === 0) { closeModal(); return; }

      var data = Storage.getData();
      var group = data.carpoolGroups.find(function(g) { return g.id === groupId; });
      if (!group) return;

      // Also find the associated chat
      var chat = data.chats.find(function(c) { return c.carpoolGroupId === groupId; });

      checkboxes.forEach(function(cb) {
        if (group.memberIds.indexOf(cb.value) === -1) {
          group.memberIds.push(cb.value);
          // Also add to chat members
          if (chat && chat.memberIds && chat.memberIds.indexOf(cb.value) === -1) {
            chat.memberIds.push(cb.value);
          }
        }
      });
      Storage.saveData(data);
      closeModal();
      render();
    }

    function showOfferRide() {
      var data = Storage.getData();
      var myGroups = (data.carpoolGroups || []).filter(function(g) {
        return g.teamId === currentUser.teamId && g.memberIds.indexOf(currentUser.id) !== -1;
      });
      var events = data.events.filter(function(e) { return e.teamId === currentUser.teamId; });

      if (myGroups.length === 0) {
        alert('You need to be in a carpool group first. Go to "My Groups" tab to create or join one.');
        return;
      }

      var groupOptions = myGroups.map(function(g) {
        return '<option value="' + g.id + '">' + g.name + '</option>';
      }).join('');

      var eventOptions = events.map(function(e) {
        return '<option value="' + e.id + '">' + (e.type === 'game' ? '‚öΩ ' : 'üèÉ ') + e.title + ' - ' + formatDate(e.date) + '</option>';
      }).join('');

      var modal = document.createElement('div');
      modal.className = 'modal';
      modal.id = 'modal';
      modal.innerHTML = '<div class="modal-content">' +
        '<div class="modal-header"><h3>Offer a Ride</h3><button class="modal-close" onclick="closeModal()">‚úï</button></div>' +
        '<p style="font-size:13px;color:#6b7280;margin-bottom:16px">Offer to drive other parents\' kids to an event. Only members of the selected group can sign up.</p>' +
        '<div class="input-group"><label>Carpool Group</label><select id="ride-group" class="input">' + groupOptions + '</select></div>' +
        '<div class="input-group"><label>Event</label><select id="ride-event" class="input">' + eventOptions + '</select></div>' +
        '<div class="input-group"><label>Available Seats (not including your child)</label><input id="ride-seats" class="input" type="number" min="1" max="6" value="2" placeholder="2"></div>' +
        '<button class="btn btn-primary" onclick="offerRide()">Offer Ride</button>' +
      '</div>';
      document.body.appendChild(modal);
    }

    function offerRide() {
      var groupId = document.getElementById('ride-group').value;
      var eventId = document.getElementById('ride-event').value;
      var seats = parseInt(document.getElementById('ride-seats').value) || 2;

      if (!groupId || !eventId) return;

      var data = Storage.getData();
      if (!data.rideOffers) data.rideOffers = [];

      // Check if user already offered a ride for this event
      var existingRide = data.rideOffers.find(function(r) {
        return r.eventId === eventId && r.driverId === currentUser.id;
      });
      if (existingRide) {
        alert('You already offered a ride for this event');
        closeModal();
        return;
      }

      data.rideOffers.push({
        id: genId(),
        groupId: groupId,
        eventId: eventId,
        driverId: currentUser.id,
        driverName: currentUser.name,
        seats: seats,
        passengers: []
      });
      Storage.saveData(data);
      closeModal();
      render();
    }

    function joinRide(rideId) {
      var data = Storage.getData();
      var ride = data.rideOffers.find(function(r) { return r.id === rideId; });
      if (!ride) return;

      if (ride.passengers.indexOf(currentUser.id) !== -1) {
        alert('You\'re already on this ride');
        return;
      }

      if (ride.passengers.length >= ride.seats) {
        alert('This ride is full');
        return;
      }

      ride.passengers.push(currentUser.id);
      Storage.saveData(data);
      render();
    }

    function leaveRide(rideId) {
      var data = Storage.getData();
      var ride = data.rideOffers.find(function(r) { return r.id === rideId; });
      if (!ride) return;

      ride.passengers = ride.passengers.filter(function(p) { return p !== currentUser.id; });
      Storage.saveData(data);
      render();
    }

    function cancelRide(rideId) {
      if (!confirm('Cancel this ride? Passengers will be notified.')) return;

      var data = Storage.getData();
      data.rideOffers = data.rideOffers.filter(function(r) { return r.id !== rideId; });
      Storage.saveData(data);
      render();
    }

    function showRoutePlanner(rideId) {
      var data = Storage.getData();
      var ride = data.rideOffers.find(function(r) { return r.id === rideId; });
      if (!ride) return;

      var event = data.events.find(function(e) { return e.id === ride.eventId; });
      if (!event) return;

      var driver = data.users.find(function(u) { return u.id === ride.driverId; });
      var driverAddress = driver && driver.address ? driver.address : 'Address not set';

      // Get passenger addresses
      var passengerStops = ride.passengers.map(function(pid) {
        var passenger = data.users.find(function(u) { return u.id === pid; });
        return {
          name: passenger ? passenger.name : 'Unknown',
          address: passenger && passenger.address ? passenger.address : 'Address not set'
        };
      });

      var eventAddress = event.address || event.location;

      // Build the stops list HTML
      var stopsHtml = '<div style="margin-bottom:16px">' +
        '<div style="display:flex;align-items:flex-start;gap:12px;padding:12px;background:#f0fdf4;border-radius:10px;margin-bottom:8px">' +
          '<div style="width:28px;height:28px;background:#16a34a;color:white;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:600;font-size:14px;flex-shrink:0">1</div>' +
          '<div style="flex:1">' +
            '<div style="font-weight:600;font-size:14px;color:#166534">Your Home (Start)</div>' +
            '<div style="font-size:13px;color:#374151;margin-top:2px">' + driverAddress + '</div>' +
          '</div>' +
        '</div>';

      passengerStops.forEach(function(stop, index) {
        stopsHtml += '<div style="display:flex;align-items:flex-start;gap:12px;padding:12px;background:#dbeafe;border-radius:10px;margin-bottom:8px">' +
          '<div style="width:28px;height:28px;background:#1d4ed8;color:white;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:600;font-size:14px;flex-shrink:0">' + (index + 2) + '</div>' +
          '<div style="flex:1">' +
            '<div style="font-weight:600;font-size:14px;color:#1e40af">Pickup: ' + stop.name + '</div>' +
            '<div style="font-size:13px;color:#374151;margin-top:2px">' + stop.address + '</div>' +
          '</div>' +
        '</div>';
      });

      stopsHtml += '<div style="display:flex;align-items:flex-start;gap:12px;padding:12px;background:#ffedd5;border-radius:10px">' +
        '<div style="width:28px;height:28px;background:#c2410c;color:white;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:600;font-size:14px;flex-shrink:0">‚öΩ</div>' +
        '<div style="flex:1">' +
          '<div style="font-weight:600;font-size:14px;color:#c2410c">' + event.title + ' (' + event.location + ')</div>' +
          '<div style="font-size:13px;color:#374151;margin-top:2px">' + eventAddress + '</div>' +
          '<div style="font-size:12px;color:#6b7280;margin-top:4px">' + formatDate(event.date) + ' at ' + event.time + '</div>' +
        '</div>' +
      '</div></div>';

      var modal = document.createElement('div');
      modal.className = 'modal';
      modal.id = 'modal';
      modal.innerHTML = '<div class="modal-content">' +
        '<div class="modal-header"><h3>Plan Your Route</h3><button class="modal-close" onclick="closeModal()">‚úï</button></div>' +
        '<p style="font-size:13px;color:#6b7280;margin-bottom:16px">Here\'s your route with all pickup stops. Open in Google Maps to see driving times and the best departure time to arrive on schedule.</p>' +
        '<h4 style="font-size:14px;font-weight:600;margin-bottom:12px">Route Stops:</h4>' +
        stopsHtml +
        '<button class="btn directions-btn" onclick="openMultiStopRoute(\'' + rideId + '\')">' +
          '<span>üó∫Ô∏è</span> Open in Google Maps' +
        '</button>' +
        '<p style="font-size:12px;color:#9ca3af;text-align:center;margin-top:8px">Google Maps will show drive times and help you plan when to leave</p>' +
        '<button class="btn btn-outline" onclick="closeModal()" style="margin-top:8px">Close</button>' +
      '</div>';
      document.body.appendChild(modal);
    }

    function openMultiStopRoute(rideId) {
      var data = Storage.getData();
      var ride = data.rideOffers.find(function(r) { return r.id === rideId; });
      if (!ride) return;

      var event = data.events.find(function(e) { return e.id === ride.eventId; });
      if (!event) return;

      var driver = data.users.find(function(u) { return u.id === ride.driverId; });
      var driverAddress = driver && driver.address ? driver.address : '';

      // Get passenger addresses as waypoints
      var waypoints = ride.passengers.map(function(pid) {
        var passenger = data.users.find(function(u) { return u.id === pid; });
        return passenger && passenger.address ? passenger.address : '';
      }).filter(function(addr) { return addr !== ''; });

      var eventAddress = event.address || event.location;

      // Build Google Maps URL with multiple stops
      // Format: origin -> waypoints -> destination
      var origin = encodeURIComponent(driverAddress);
      var destination = encodeURIComponent(eventAddress);
      var waypointsParam = waypoints.length > 0 ? '&waypoints=' + waypoints.map(function(wp) { return encodeURIComponent(wp); }).join('|') : '';

      var mapsUrl = 'https://www.google.com/maps/dir/?api=1&origin=' + origin + '&destination=' + destination + waypointsParam + '&travelmode=driving';

      window.open(mapsUrl, '_blank');
    }

    // ===== INIT =====
    render();
  </script>
</body>
</html>
